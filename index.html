<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AV</title>
    <style media="screen">
      canvas, video {outline: 2px solid #08f;}
      canvas {width: 300px;  image-rendering: pixelated;}
    </style>
  </head>
  <body>
    <script>
      const audioCtx = new AudioContext()
      const video = document.createElement('video')
      const cSource = document.createElement('canvas')
      const cTarget = document.createElement('canvas')
      const ctxSource = cSource.getContext('2d')
      const ctxTarget = cTarget.getContext('2d')

      // 64*64 * 4 =  8192 * 2
      const size = 64

      // set size and append canvas
      ![cSource, cTarget].forEach(c =>
        document.body.appendChild(
          Object.assign(c, {width: size, height: size})
        )
      )

      async function start() {

        video.srcObject = await navigator.mediaDevices.getUserMedia({
          audio: false, video: {width: size, height: size}
        })

        video.play()

        function loop() {
          requestAnimationFrame(loop)
          ctxSource.drawImage(video, 0, 0 )
        }

        loop()

        const source = audioCtx.createScriptProcessor(8192,2,2)
        const output = audioCtx.createScriptProcessor(8192,2,2)

        source.onaudioprocess = evt => {
          const imData = ctxSource.getImageData(0,0,size,size)

          const outputBuffer = evt.outputBuffer
          const auData = outputBuffer.getChannelData(0)
          const auData1 = outputBuffer.getChannelData(1)

          for (let i = 0; i < auData.length; i++) {
            auData[i] = imData.data[i]
            auData1[i] = imData.data[i + auData.length]
          }
        }

        output.onaudioprocess = evt => {
          const imData = ctxTarget.getImageData(0,0,size,size)

          const inputBuffer = evt.inputBuffer
          const auData = inputBuffer.getChannelData(0)
          const auData1 = inputBuffer.getChannelData(1)

          for (let i = 0; i < auData.length; i++) {
            imData.data[i] = auData[i]
            imData.data[i + auData.length] = auData1[i]
          }

          ctxTarget.putImageData(imData,0,0)
        }

        source.connect(output)
        output.connect(audioCtx.destination)

      }

      start()
    </script>
  </body>
</html>
